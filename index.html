<!DOCTYPE html>
<html>
<head>
	<title>plop</title>
</head>
<body>
	<button onclick="addPos('basic')">Drapeau</button>
	<button id="flag" onclick="watchPos('flag')">Drapeau</button>
	<button id="green" onclick="watchPos('green')">Entrée de green</button>
	<button id="start" onclick="watchPos('start')">Zone de frappe</button>
	<div id="infoposition"></div>
	<hr>
	<div id="infopositionB"></div>
</body>
<script
  src="https://code.jquery.com/jquery-3.4.1.js"
  integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
  crossorigin="anonymous"></script>
<script type="text/javascript">
	//init
	var watchType = undefined;
	var watchVar;
	var watchTab = [];
	var deltaBase = ['flag', 'green', 'start'];

	var type = "";
	var pos = {
		"old": {
			"lat": undefined,
			"long": undefined,
			"alt": undefined
		},
		"new": {
			"lat": undefined,
			"long": undefined,
			"alt": undefined
		},
		"delta": {
			"dist": 0,
			"alt": 0
		}
	}
	var exercice = {
		"flag": {
			"lat": undefined,
			"long": undefined,
			"alt": undefined
		},
		"green": {
			"lat": undefined,
			"long": undefined,
			"alt": undefined
		},
		"start": {
			"lat": undefined,
			"long": undefined,
			"alt": undefined
		}

	}

	//check
	console.log("V0");
	console.log('js: ON');
	if(navigator.geolocation) {
		console.log('geo: ON')
	} else {
		console.log('geo: OFF')
		document.getElementById("infoposition").innerHTML += "geolocation is disabled";
	}

	//process & logic
	function log(position) {
		console.log(type)
		console.log(position)
		//gestion de l'exercice

		if(pos.old) {
			pos.old.lat = pos.new.lat;
			pos.old.long = pos.new.long;
			pos.old.alt = pos.new.alt;
		}

		pos.new.lat = position.coords.latitude;
		pos.new.long = position.coords.longitude;
		pos.new.alt = position.coords.altitude;

		maPosition(position)
	}

	function logB(position) {
		watchTab.push(position);
		console.log(watchTab);

		maPositionB(position)
	}

	function maPosition(position) {
		var infopos = "<p>Position déterminée : <br>";
		infopos += "Latitude : <strong>" + position.coords.latitude + "</strong> ";
		infopos += "Longitude: <strong>" + position.coords.longitude + "</strong> ";
		infopos += "Altitude : <strong>" + position.coords.altitude + "</strong> ";
		infopos += "Accuracy : <strong>" + position.coords.accuracy + "</strong> ";
		infopos += "Dist : <strong>" + delta() + "</strong> </p>";
		document.getElementById("infoposition").innerHTML += infopos;

		console.log(delta());
	}

	function maPositionB(position) {
	    var infopos = "<p>Position déterminée :\n";
	    infopos += "Latitude : <strong>"+position.coords.latitude +"</strong> ";
	    infopos += "Longitude: <strong>"+position.coords.longitude+"</strong> ";
	    infopos += "Altitude : <strong>"+position.coords.altitude +"</strong> ";
	    infopos += "Vitesse  : <strong>"+position.coords.speed +"</strong> ";
		infopos += "Accuracy : <strong>" + position.coords.accuracy + "</strong>";
		infopos += "Dist : <strong>" + deltaB() + "</strong> </p>";
	    document.getElementById("infopositionB").innerHTML += infopos;
	}

	function delta() {
		if (((pos.old.lat == pos.new.lat) && (pos.old.long == pos.new.long)) || !pos.old.lat) {
			return 0;
		}
		else {
			var radlat1 = Math.PI * pos.old.lat/180;
			var radlat2 = Math.PI * pos.new.lat/180;
			var theta = pos.old.long-pos.new.long;
			var radtheta = Math.PI * theta/180;
			var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
			if (dist > 1) {
				dist = 1;
			}
			dist = Math.acos(dist);
			dist = dist * 180/Math.PI;
			dist = dist * 60 * 1.1515*1.609344*1000;
			return dist;
		}
	}

	function deltaB() {
		if(watchType == 'flag')
			return 0

		if ((exercice[deltaBase[deltaBase.indexof(watchType)-1]].lat == watchTab[watchTab.length-1].coords.latitude) && (exercice[deltaBase[deltaBase.indexof(watchType)-1]].long == watchTab[watchTab.length-1].coords.longitude)) {
			return 0;
		}
		else {
			var radlat1 = Math.PI * exercice[deltaBase[deltaBase.indexof(watchType)-1]].lat/180;
			var radlat2 = Math.PI * watchTab[watchTab.length-1].coords.latitude/180;
			var theta = exercice[deltaBase[deltaBase.indexof(watchType)-1]].long-watchTab[watchTab.length-1].coords.longitude;
			var radtheta = Math.PI * theta/180;
			var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
			if (dist > 1) {
				dist = 1;
			}
			dist = Math.acos(dist);
			dist = dist * 180/Math.PI;
			dist = dist * 60 * 1.1515*1.609344*1000;
			return dist;
		}
	}

	function addPos(evt){
		type = evt;
		if(navigator.geolocation)
		navigator.geolocation.getCurrentPosition(log);
	}

	function watchPos(evt) {
		if(evt == watchType) {
			save();
			watchType = undefined;
			watchTab = [];
			navigator.geolocation.clearWatch(watchVar);

			$("button").attr("disabled", false)

		}else {
			watchVar = navigator.geolocation.watchPosition(logB, err, {maximumAge:0, enableHighAccuracy :true});
			watchType = evt

			$("button").attr("disabled", true)
			$("#" + evt + "").attr("disabled", false)
		}
	}

	function err (evt) {
		document.getElementById("infopositionB").innerHTML += err;
	}

	function save() {
		exercice[watchType].lat = watchTab[watchTab.length-1].coords.latitude;
		exercice[watchType].long = watchTab[watchTab.length-1].coords.longitude;
		exercice[watchType].alt = watchTab[watchTab.length-1].coords.altitude;
	}

	addPos('start');

</script>
</html>